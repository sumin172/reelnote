generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("CATALOG_DB_URL")
  shadowDatabaseUrl = env("PRISMA_SHADOW_DATABASE_URL")
}

model Movie {
  tmdbId          Int            @id @map("tmdb_id")
  title           String
  originalTitle   String         @map("original_title")
  year            Int?
  runtime         Int?
  language        String?
  country         String?
  posterPath      String?        @map("poster_path")
  popularity      Float?
  voteAvg         Float?         @map("vote_avg")
  voteCnt         Int?           @map("vote_cnt")
  syncedAt        DateTime       @default(now()) @map("synced_at")
  rawJson         Json           @map("raw_json")
  sourceHash      String?        @map("source_hash")
  sourceUpdatedAt DateTime?      @map("source_updated_at")
  cast            MovieCast[]
  crew            MovieCrew[]
  features        MovieFeature?
  genres          MovieGenre[]
  keywords        MovieKeyword[]

  @@map("movie")
}

model Genre {
  id     Int          @id @default(autoincrement())
  name   String       @unique
  movies MovieGenre[]

  @@map("genre")
}

model MovieGenre {
  tmdbId  Int   @map("tmdb_id")
  genreId Int   @map("genre_id")
  genre   Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)
  movie   Movie @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)

  @@id([tmdbId, genreId])
  @@map("movie_genre")
}

model Keyword {
  id     Int            @id @default(autoincrement())
  name   String         @unique
  movies MovieKeyword[]

  @@map("keyword")
}

model MovieKeyword {
  tmdbId    Int     @map("tmdb_id")
  keywordId Int     @map("keyword_id")
  keyword   Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  movie     Movie   @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)

  @@id([tmdbId, keywordId])
  @@map("movie_keyword")
}

model Person {
  id           Int         @id @default(autoincrement())
  name         String
  tmdbPersonId Int?        @unique @map("tmdb_person_id")
  castRoles    MovieCast[]
  crewRoles    MovieCrew[]

  @@map("person")
}

model MovieCast {
  tmdbId    Int     @map("tmdb_id")
  personId  Int     @map("person_id")
  character String?
  order     Int     @default(0)
  person    Person  @relation(fields: [personId], references: [id], onDelete: Cascade)
  movie     Movie   @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)

  @@id([tmdbId, personId])
  @@map("movie_cast")
}

model MovieCrew {
  tmdbId     Int     @map("tmdb_id")
  personId   Int     @map("person_id")
  job        String
  department String?
  person     Person  @relation(fields: [personId], references: [id], onDelete: Cascade)
  movie      Movie   @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)

  @@id([tmdbId, personId, job])
  @@map("movie_crew")
}

model MovieFeature {
  tmdbId         Int                    @id @map("tmdb_id")
  tagsWeight     Json?                  @map("tags_weight")
  embedding      Unsupported("vector")?
  sentimentStats Json?                  @map("sentiment_stats")
  updatedAt      DateTime               @default(now()) @map("updated_at")
  movie          Movie                  @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)

  @@map("movie_feature")
}

model UserProfile {
  userId    String                 @id @map("user_id")
  tagPref   Json?                  @map("tag_pref")
  embedding Unsupported("vector")?
  updatedAt DateTime               @default(now()) @map("updated_at")

  @@map("user_profile")
}
